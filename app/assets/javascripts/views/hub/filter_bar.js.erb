var TW = TW || {};
TW.workbench = TW.workbench || {};
TW.workbench.hub = TW.workbench.hub || {};
TW.workbench.hub.filter_hub = TW.workbench.hub.filter_hub || {};

Object.assign(TW.workbench.hub.filter_hub, {

  init: function () {
    const filter = document.getElementById('filter');
    
    if (!filter.hasAttribute('icons-loaded')) {
      filter.setAttribute('icons-loaded', 'true');
      const icons = {
        nomenclature: "<%= asset_path("new.svg") %>",
        source: "<%= asset_path("book.svg") %>",
        collection_object: "<%= asset_path("bug.svg") %>",
        collecting_event: "<%= asset_path("geo_location.svg") %>",
        biology: "<%= asset_path("biology.svg") %>",
        matrix: "<%= asset_path("matrix.svg") %>",
        dna: "<%= asset_path("helix.svg") %>",
        image: "<%= asset_path("image.svg") %>"
      }

      Object.entries(icons).forEach(([category, path]) => {
        document.querySelectorAll(`[data-filter-category="${category}"]`).forEach(el => {
          const img = document.createElement('img')
          img.src = path
          el.prepend(img)
        })
      })
    }
  

    function deactivateBackgroundColorLink(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el.classList.remove('activated')
      })
    }

    function activateBackgroundColorLink(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el.classList.add('activated')
      })
    }

    function changeBackgroundColorLink(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el.classList.toggle('activated')
      })
    }

    filter.querySelectorAll('[data-filter-category]').forEach(el => {
      el.addEventListener('click', function () {
        const parent = this.parentElement;
        if (!parent.classList.contains('navigation-controls-type')) {
          const category = this.getAttribute('data-filter-category');
          changeBackgroundColorLink(`[data-filter-category="${category}"]`);
        }
      });
    });

    filter.querySelectorAll('.filter-category [data-filter-category]').forEach(el => {
      el.addEventListener('click', function () {
        const wasActive = this.classList.contains('activated');
        deactivateBackgroundColorLink('.filter-category [data-filter-category]');

        if (wasActive) {
          const category = this.getAttribute('data-filter-category');
          const bgColor = window.getComputedStyle(this).backgroundColor;

          document.querySelectorAll('.status-name').forEach(status => {
            status.textContent = category;
            status.style.color = bgColor;
          });

          activateBackgroundColorLink(`[data-filter-category="${category}"]`);
        } else {
          restartFilterStatus();
        }
      });
    });

    filter.querySelectorAll('.switch input').forEach(input => {
      input.addEventListener('click', function () {
        const isChecked = this.checked;
        const filterCategories = document.querySelectorAll('.filter-category');
        const filterDataBlocks = document.querySelectorAll('.filter_data');

        if (isChecked) {
          filterCategories.forEach(fc => {
            fc.style.display = 'flex';
          });

          filterDataBlocks.forEach(fd => {
            if (fd.children.length > 0) {
              fd.classList.add('categories')
            }
          });
        } else {
          restartFilterStatus()
          deactivateBackgroundColorLink('.filter-category [data-filter-category]')

          filterCategories.forEach(fc => {
            fc.style.display = 'none'
          });

          filterDataBlocks.forEach(fd => {
            fd.classList.remove('categories', 'status')
          })
        }
      })
    })

    function restartFilterStatus() {
      document.querySelectorAll('.status-name').forEach(status => {
        status.textContent = 'Status';
        status.style.color = '#444';
      })
    }

    filter.querySelectorAll('[data-filter-category="reset"]').forEach(el => {
      el.addEventListener('click', function () {
        restartFilterStatus();
        deactivateBackgroundColorLink('[data-filter-category]')
      })
    })

    document.querySelectorAll('.reset-all-filters').forEach(el => {
      el.addEventListener('click', function () {
        restartFilterStatus();
        deactivateBackgroundColorLink('[data-filter-category]')
      })
    })
  }
})

document.addEventListener('turbolinks:load', function () {
  if (document.getElementById('filter')) {
    TW.workbench.hub.filter_hub.init()
  }
})