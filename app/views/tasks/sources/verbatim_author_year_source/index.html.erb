<h2>Task - TaxonName verbatim author/year without citations</h2>

<div>
  <%= link_to('Back to Filter TaxonNames', filter_taxon_names_task_path) %>
</div>

<% if @author_year_data.empty? %>
  <p><em>No TaxonNames with verbatim author and year found.</em></p>
<% else %>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <p style="margin: 0;">Found <%= @author_year_data.size %> unique author/year combinations.</p>
    <div style="display: flex; gap: 10px;">
      <button type="button" class="btn-jump-to-most" onclick="jumpToMost()">Jump to most</button>
      <button type="button" class="btn-refresh" onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <table class="tablesorter">
    <thead>
      <tr>
        <%= fancy_th_tag(name: 'Author') %>
        <%= fancy_th_tag(name: 'Year') %>
        <%= fancy_th_tag(name: 'Count') %>
        <%= fancy_th_tag(name: 'New Source') %>
        <%= fancy_th_tag(name: 'Filter') %>
        <%= fancy_th_tag(name: 'Taxon names') %>
        <%= fancy_th_tag(name: 'Batch Cite') %>
      </tr>
    </thead>
    <tbody>
      <% @author_year_data.each do |row| %>
        <% heat_color = Utilities::Heatmap.heatmap_color_for(row.record_count.to_f / @max_count, curve: :citation_count, count: row.record_count) %>
        <tr data-author="<%= row.verbatim_author %>" data-year="<%= row.year_of_publication %>" data-count="<%= row.record_count %>">
          <td><%= row.verbatim_author %></td>
          <td><%= row.year_of_publication %></td>
          <td style="background-color: <%= heat_color %>; color: white; font-weight: bold; text-align: center;">
            <%= row.record_count %>
          </td>
          <td>
            <%= link_to(
              'New Source',
              new_source_task_path,
              target: '_blank'
            ) %>
          </td>
          <td>
            <%= link_to(
              'Filter TaxonNames',
              filter_taxon_names_task_path(
                author: row.verbatim_author,
                author_exact: true,
                year_of_publication: row.year_of_publication
              ),
              target: '_blank'
            ) %>
          </td>
          <td>
            <button type="button" class="btn-preview" data-author="<%= row.verbatim_author %>" data-year="<%= row.year_of_publication %>">
              Taxon names
            </button>
          </td>
          <td class="batch-cite-cell">
            <button type="button" class="btn-cite" data-author="<%= row.verbatim_author %>" data-year="<%= row.year_of_publication %>">
              Cite
            </button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<!-- Source Selection Modal -->
<div id="source-modal" class="modal-mask" style="display: none;">
  <div class="modal-wrapper">
    <div class="modal-container">
      <div class="modal-header">
        <h3>Select Source for Citation</h3>
        <button type="button" class="modal-close" onclick="closeSourceModal()">×</button>
      </div>
      <div class="modal-body">
        <div id="source-list-spinner" style="text-align: center; padding: 20px;">
          Loading recent sources...
        </div>
        <table id="source-list" style="display: none; width: 100%;">
          <thead>
            <tr>
              <th>Source</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="source-list-body">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Preview TaxonNames Modal -->
<div id="preview-modal" class="modal-mask" style="display: none;">
  <div class="modal-wrapper">
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="preview-modal-title">Preview TaxonNames</h3>
        <button type="button" class="modal-close" onclick="closePreviewModal()">×</button>
      </div>
      <div class="modal-body">
        <div id="preview-spinner" style="text-align: center; padding: 20px;">
          Loading TaxonNames...
        </div>
        <table id="preview-table" style="display: none; width: 100%;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Author</th>
              <th>Year</th>
            </tr>
          </thead>
          <tbody id="preview-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
.modal-mask {
  position: fixed;
  z-index: 9998;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

.modal-container {
  background: white;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.33);
  padding: 20px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-body table td {
  padding: 8px;
}

.modal-body table th {
  padding: 8px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  line-height: 1;
  color: #666;
}

.modal-close:hover {
  color: #000;
}

.btn-cite, .btn-preview, .btn-refresh, .btn-jump-to-most {
  padding: 4px 12px;
  background-color: #5D9CE8;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.btn-cite:hover, .btn-preview:hover, .btn-refresh:hover, .btn-jump-to-most:hover {
  background-color: #4A8CD6;
}

.btn-cite:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.btn-select-source {
  padding: 4px 12px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.btn-select-source:hover {
  background-color: #45a049;
}

.batch-pending {
  color: #666;
  font-style: italic;
}
</style>

<script>
let currentAuthor = null;
let currentYear = null;

// Add click handlers to all cite and preview buttons
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-cite').forEach(function(btn) {
    btn.addEventListener('click', function() {
      currentAuthor = this.getAttribute('data-author');
      currentYear = this.getAttribute('data-year');
      openSourceModal();
    });
  });

  document.querySelectorAll('.btn-preview').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const author = this.getAttribute('data-author');
      const year = this.getAttribute('data-year');
      openPreviewModal(author, year);
    });
  });
});

function jumpToMost() {
  // Find all rows with batch-cite-cell that still have a button (not cited yet)
  const rows = Array.from(document.querySelectorAll('tbody tr'));
  const activeRows = rows.filter(function(row) {
    const cell = row.querySelector('.batch-cite-cell');
    return cell && cell.querySelector('.btn-cite');
  });

  if (activeRows.length === 0) {
    TW.workbench.alert.create('No uncited rows remaining', 'notice');
    return;
  }

  // Find the row with the highest count
  let maxCount = 0;
  let targetRow = null;

  activeRows.forEach(function(row) {
    const count = parseInt(row.getAttribute('data-count'));
    if (count > maxCount) {
      maxCount = count;
      targetRow = row;
    }
  });

  if (targetRow) {
    // Scroll to the row with smooth behavior
    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Highlight the row briefly
    targetRow.style.outline = '3px solid #5D9CE8';
    setTimeout(function() {
      targetRow.style.outline = '';
    }, 2000);
  }
}

function openSourceModal() {
  const modal = document.getElementById('source-modal');
  const spinner = document.getElementById('source-list-spinner');
  const table = document.getElementById('source-list');

  modal.style.display = 'block';
  spinner.style.display = 'block';
  table.style.display = 'none';

  // Fetch recent sources
  fetch('/sources.json?per=10&recent=true')
    .then(response => response.json())
    .then(sources => {
      displaySources(sources);
    })
    .catch(error => {
      console.error('Error fetching sources:', error);
      spinner.innerHTML = 'Error loading sources';
    });
}

function closeSourceModal() {
  document.getElementById('source-modal').style.display = 'none';
  currentAuthor = null;
  currentYear = null;
}

function openPreviewModal(author, year) {
  const modal = document.getElementById('preview-modal');
  const title = document.getElementById('preview-modal-title');
  const spinner = document.getElementById('preview-spinner');
  const table = document.getElementById('preview-table');

  title.textContent = author + ' ' + year;
  modal.style.display = 'block';
  spinner.style.display = 'block';
  table.style.display = 'none';

  // Fetch TaxonNames for this author/year using exact match
  const queryParams = new URLSearchParams({
    author: author,
    author_exact: true,
    year_of_publication: year
  });

  fetch('/taxon_names.json?' + queryParams.toString())
    .then(response => response.json())
    .then(taxonNames => {
      displayPreviewTaxonNames(taxonNames);
    })
    .catch(error => {
      console.error('Error fetching TaxonNames:', error);
      spinner.innerHTML = 'Error loading TaxonNames';
    });
}

function closePreviewModal() {
  document.getElementById('preview-modal').style.display = 'none';
}

function displayPreviewTaxonNames(taxonNames) {
  const tbody = document.getElementById('preview-table-body');
  const spinner = document.getElementById('preview-spinner');
  const table = document.getElementById('preview-table');

  tbody.innerHTML = '';

  taxonNames.forEach(function(tn) {
    const row = tbody.insertRow();
    const cellName = row.insertCell(0);
    const cellAuthor = row.insertCell(1);
    const cellYear = row.insertCell(2);

    cellName.textContent = tn.cached || tn.name || 'TaxonName #' + tn.id;
    cellAuthor.textContent = tn.verbatim_author || '';
    cellYear.textContent = tn.year_of_publication || '';
  });

  spinner.style.display = 'none';
  table.style.display = 'table';
}

function displaySources(sources) {
  const tbody = document.getElementById('source-list-body');
  const spinner = document.getElementById('source-list-spinner');
  const table = document.getElementById('source-list');

  tbody.innerHTML = '';

  sources.forEach(function(source) {
    const row = tbody.insertRow();
    const cellSource = row.insertCell(0);
    const cellAction = row.insertCell(1);

    cellSource.innerHTML = source.cached || source.object_tag || 'Source #' + source.id;
    cellAction.innerHTML = '<button type="button" class="btn-select-source" onclick="selectSource(' + source.id + ')">Select</button>';
  });

  spinner.style.display = 'none';
  table.style.display = 'table';
}

function selectSource(sourceId) {
  // Store values before closing modal
  const author = currentAuthor;
  const year = currentYear;

  closeSourceModal();
  batchCite(author, year, sourceId);
}

function batchCite(author, year, sourceId) {
  // Find the button for this author/year - need to escape quotes in author name
  const escapedAuthor = author.replace(/'/g, "\\'");
  const button = document.querySelector('.btn-cite[data-author="' + escapedAuthor + '"][data-year="' + year + '"]');

  if (!button) {
    console.error('Could not find button for author:', author, 'year:', year);
    return;
  }

  const cell = button.parentElement;

  // Disable button and show pending state
  button.disabled = true;
  cell.innerHTML = '<span class="batch-pending">Creating citations...</span>';

  // First, get the TaxonName IDs for this author/year using exact match
  const queryParams = new URLSearchParams({
    author: author,
    author_exact: true,
    year_of_publication: year
  });

  fetch('/taxon_names.json?' + queryParams.toString())
    .then(response => response.json())
    .then(taxonNames => {
      const ids = taxonNames.map(tn => tn.id);

      // Now batch create citations
      return fetch('/citations/batch_create.json', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          citation: {
            citation_object_type: 'TaxonName',
            citation_object_id: ids,
            source_id: sourceId
          }
        })
      });
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Batch citation failed');
      }
    })
    .then(result => {
      cell.innerHTML = '<span class="batch-pending">✓ Citations created</span>';
      TW.workbench.alert.create('Citations were successfully created', 'notice');

      // Row will disappear on page reload since these taxon names now have citations
    })
    .catch(error => {
      console.error('Error creating citations:', error);
      cell.innerHTML = '<button type="button" class="btn-cite" data-author="' + author + '" data-year="' + year + '" onclick="this.click()">Cite (retry)</button>';
      TW.workbench.alert.create('Error creating citations', 'error');

      // Re-attach event listener
      cell.querySelector('.btn-cite').addEventListener('click', function() {
        currentAuthor = this.getAttribute('data-author');
        currentYear = this.getAttribute('data-year');
        openSourceModal();
      });
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
  const sourceModal = document.getElementById('source-modal');
  const previewModal = document.getElementById('preview-modal');

  if (event.target === sourceModal) {
    closeSourceModal();
  }

  if (event.target === previewModal) {
    closePreviewModal();
  }
});

// Close modals with ESC key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' || event.key === 'Esc') {
    const sourceModal = document.getElementById('source-modal');
    const previewModal = document.getElementById('preview-modal');

    if (sourceModal.style.display === 'block') {
      closeSourceModal();
    }

    if (previewModal.style.display === 'block') {
      closePreviewModal();
    }
  }
});
</script>
